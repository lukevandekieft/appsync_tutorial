service:
  name: serverless-appsync-backend

plugins:
  - serverless-plugin-additional-stacks
  - serverless-iam-roles-per-function
  - serverless-plugin-include-dependencies

provider:
  name: aws
  runtime: nodejs8.10
  profile: default
  region: us-west-2
  timeout: 120
  stage: ${opt:stage, "test"}

custom:
  base: ${self:service}-${self:provider.stage}
  account: ${file(./config/config.${self:provider.stage}.json):account}
  db: ${file(./config/config.test.json):db}
  # Base naming convention for all resources
  cognitoStackName: ${self:custom.base}-cognito
  dynamoDBStackName: ${self:custom.base}-dynamodb

# User Pool Id import from Cognito stack
  userPoolId:
    Fn::ImportValue: ${self:custom.cognitoStackName}:${self:provider.stage}:${self:custom.base}-UserPoolId

  # IAM
  role:
    arn: arn:aws:iam::${self:custom.account.id}:role  # /<role_name>
    cognito:
      auth:
        name: ${self:custom.base}-auth-CognitoRole
        arn: ${self:custom.role.arn}/${self:custom.role.cognito.auth.name}
      unAuth:
        name: ${self:custom.base}-unAuth-CognitoRole
        arn: ${self:custom.role.arn}/${self:custom.role.cognito.unAuth.name}

  # Plugin: additionalStacks (nesting CF stacks)
  additionalStacks:
    # deploys cognitoResources stack
    # creates cognito user pool
    # outputs cognito user pool info for appSyncResources stack
    cognitoResources:
      Deploy: Before
      StackName: ${self:custom.cognitoStackName}
      Resources: ${file(./resources/cognito.yml)}
      Outputs: ${file(./resources/cognito-outputs.yml)}
    # deploys dynamoDBResources stack
    # creates users table
    dynamoDBResources:
      Deploy: Before
      StackName: ${self:custom.dynamoDBStackName}
      Resources: ${file(./resources/dynamodb.yml)}
